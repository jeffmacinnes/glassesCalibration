---
title: "Wearable Eye-tracker Calibration Analyses"
author: "jeff macinnes"
date: "July 17, 2017"
output: 
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
```

# Wearable Eye-tracker Calibration Analyses

A set of analyses comparing calibration performance across 3 different models of wearable eye-trackers: Tobii Glasses 2, SMI, and Pupil Labs. Each tracker was tested on 3 different subjects. Each subject performed calibration tasks at 3 different distances (1M, 2M, and 3M). At each distance, calibration was tested at 3 different conditons of visual angle offset (-10deg, 0deg, +10deg). The calibration task consisted of asking participants to fixate on a sequence of 9 calibration points (3 x 3 grid) presented in a random order for 3 seconds each. The analysis focuses on the gaze data collected between 500ms and 2500ms on each point.

## Read in processed calibration data file
Each row represents the calibration performance summary for one pt (of 9) for one conditon for one subject. 

```{r chunk1, message=FALSE}
library(readr)
library(knitr)

calibData <- read_delim("allSubjs_calibrationSummary.tsv", delim="\t")
kable(calibData[1:5,], caption='Calibration Data, all subjects')
```

**Variable Descriptions** 

- trial: trial number  
- ptIdx: points on calibration grid were numbered from left to right, top to bottom. 25 points total, of which subjects were asked to fixate on a subset of 9.  
- percentValid: within the 2000ms window on each trial that is selected for analysis, this represented the percentage of *expected* datapoints with valid data  
- centX: mean x-coordinate of all gaze points on this trial
- centY: mean y-coordinate of all gaze points on this trial
- centDist: **accuracy measure** distance (in degrees of visual angle) of mean gaze point from the expected location
- centAngle: theta (in degrees) of mean gaze point relative to the expected location. 0 degs is at (1,0) on unit circle, and increases in a counterclockwise direction
- RMS: **precision measure**. Root mean square distance of all gaze points in this trial from each other
- subj: subject number
- dist: subject distance from the target on this trial
- offset: target offset (in visual angle) from the subject on this trial; negative values to the subject's left, positive values to the right

## Average each condition across all calibration points
The calibData dataframe has summarized each individual calibration pt (9 total) for each unique condition. Before any other analyses, average the calibration performance across these 9pts for each condition

```{r chunk2, message=FALSE, warning=FALSE} 
# load dplyr library
library(dplyr)

# group by unique conditions, and take the mean of all numeric columns
dat <- calibData %>% 
  group_by(subj, glasses, dist, offset) %>%
  summarise_if(is.numeric, mean)

# drop the columns that are now irrelevant
dat <- dat %>% select(-one_of(c("trial", "ptIdx")))

# show a table
kable(dat[1:5,], caption='Calibration data, mean by unique condition')
```

# Models  

---
## Overall  
Collapsing across all conditions (distance and visual angle offset)

#### Accuracy
Test if there's an overall effect of glasses model on accuracy (i.e. centDist). Collapsing across all distance and offset, with subject as a random effect

```{r chunk3}
# load the nlme packages, which includes functions for fitting mixed models
library(lme4)
library(lmerTest)

# build a linear mixed effects model predicting centDist as a function of glasses, with subj as a random effect
overallAcc <- lmer(centDist ~ glasses + (1|subj), data=dat)
summary(overallAcc)

anova(overallAcc)


```

Glasses model is a significant predictor of overall accuracy. Next, run post-hocs to look for significant differences between glasses. (Methods for running pairwise t-tests on linear model object found at: https://stats.stackexchange.com/questions/237512/how-to-perform-post-hoc-test-on-lmer-model)

```{r}
library(multcomp)
summary(glht(overallAcc, linfct = mcp(glasses = "Tukey")), test = adjusted("holm"))
```

Pupil Labs show significantly better Accuracy than either SMI or Tobii. No significant difference between SMI and Tobii

#### Precision
Test if there's an overall effect of glasses model on precision (i.e. RMS). Collapsing across all distance and offset, with subject as a random effect


```{r chunk4}
# build a linear mixed effects model predicting RMS as a function of glasses, with subj as a random effect
overallPrec <- lmer(RMS ~ glasses + (1|subj), data=dat)
summary(overallPrec)

anova(overallPrec)

```

Glasses model is a significant predictor of overall precision. Run Post hoc t-tests to make comparisons between models

```{r chunk5}
summary(glht(overallPrec, linfct = mcp(glasses = "Tukey")), test = adjusted("holm"))

```

Tobii exhibits significantly different precision than either SMI or Pupil Labs. No significant difference between SMI and Pupil Labs. 

#### Overall Accuracy and Precision Plots

```{r chunk6}
# overall Accuracy plot
library(ggplot2)
library(ggthemes)
library(ggpubr)

## Accuracy
accPlot <- ggplot(aes(y = centDist, x = glasses, fill=glasses), 
       data = dat) +
  geom_boxplot() +
  labs( 
    x = "Wearable Eye-tracker",
    y = "Visual Angle (deg)",
    title="Accuracy"
    ) +
  scale_fill_brewer(palette="Greens") +
  scale_y_continuous(breaks=seq(0,2,by=1), limits=c(0,2.5), expand=c(0,.1)) +
  theme(
    aspect.ratio = 1.5,
    panel.background = element_blank(),
    plot.title = element_text(hjust=.5, size=18),
    axis.title = element_text(size=rel(1.3)),
    axis.text.x = element_text(size = rel(1.3)),
    axis.text.y = element_text(size = rel(1.5)),
    axis.line.y = element_line(colour = "black", size = .5, linetype = "solid"),
    axis.ticks.x = element_blank(),
    panel.grid.major.y = element_line(colour="darkgrey", linetype = "twodash", size=.25),
    legend.position = "none",
  ) +
  geom_segment(aes(x = .4, y = 0, xend = 3.6, yend = 0), size=.25)


## Precision
rmsPlot <- ggplot(aes(y = RMS, x = glasses, fill=glasses), 
                  data = dat) +
  geom_boxplot() +
  labs( 
    x = "Wearable Eye-tracker",
    y = "RMS",
    title="Precision"
  ) +
  scale_fill_brewer(palette="Greens") +
  scale_y_continuous(breaks=seq(0,.8,by=.2), limits=c(0,.7), expand=c(0,.03)) +
  theme(
    aspect.ratio = 1.5,
    panel.background = element_blank(),
    plot.title = element_text(hjust=.5, size=18),
    axis.title = element_text(size=rel(1.3)),
    axis.text.x = element_text(size = rel(1.3)),
    axis.text.y = element_text(size = rel(1.5)),
    axis.line.y = element_line(colour = "black", size = .5, linetype = "solid"),
    axis.ticks.x = element_blank(),
    panel.grid.major.y = element_line(colour="darkgrey", linetype = "twodash", size=.25),
    legend.position = "none",
  ) +
  geom_segment(aes(x = .4, y = 0, xend = 3.6, yend = 0), size=.25)

## Combine plots
ggarrange(accPlot, rmsPlot,  
          labels = c("A", "B"),
          ncol = 2, nrow = 1) + 
  ggsave("figs/overallAccPrec.pdf", width = 8, height = 5)
```


** Models to run **  

	- ~~Overall (avg across all distance and offset conditions)~~
		- ~~accuracy x glasses model~~
		- ~~precision x glasses model~~

	- Distance (fixed offset, 0deg)
		- accuracy x distance x glasses model
		- precision x distance x glasses model

	- Distance + Offset
		- accuracy x distance x offset x glasses model
		- precision x distance x offset x glasses model


## Session Info  
Display all session info (R and R package version numbers)
```{r}
sessionInfo()
```


