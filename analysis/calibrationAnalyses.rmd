---
title: "Wearable Eye-tracker Calibration Analyses"
author: "jeff macinnes"
date: "July 17, 2017"
output: 
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
```

# Wearable Eye-tracker Calibration Analyses

A set of analyses comparing calibration performance across 3 different models of wearable eye-trackers: Tobii Glasses 2, SMI, and Pupil Labs. Each tracker was tested on 3 different subjects. Each subject performed calibration tasks at 3 different distances (1M, 2M, and 3M). At each distance, calibration was tested at 3 different conditons of visual angle offset (-10deg, 0deg, +10deg). The calibration task consisted of asking participants to fixate on a sequence of 9 calibration points (3 x 3 grid) presented in a random order for 3 seconds each. The analysis focuses on the gaze data collected between 500ms and 2500ms on each point.

## Read in processed calibration data file
Each row represents the calibration performance summary for one pt (of 9) for one conditon for one subject. 

```{r chunk1, message=FALSE}
library(readr)
library(knitr)

calibData <- read_delim("allSubjs_calibrationSummary.tsv", delim="\t")
kable(calibData[1:5,], caption='Calibration Data, all subjects')
```

**Variable Descriptions** 

- trial: trial number  
- ptIdx: points on calibration grid were numbered from left to right, top to bottom. 25 points total, of which subjects were asked to fixate on a subset of 9.  
- percentValid: within the 2000ms window on each trial that is selected for analysis, this represented the percentage of *expected* datapoints with valid data  
- centX: mean x-coordinate of all gaze points on this trial
- centY: mean y-coordinate of all gaze points on this trial
- centDist: **accuracy measure** distance (in degrees of visual angle) of mean gaze point from the expected location
- centAngle: theta (in degrees) of mean gaze point relative to the expected location. 0 degs is at (1,0) on unit circle, and increases in a counterclockwise direction
- RMS: **precision measure**. Root mean square distance of all gaze points in this trial from each other
- subj: subject number
- dist: subject distance from the target on this trial
- offset: target offset (in visual angle) from the subject on this trial; negative values to the subject's left, positive values to the right

## Average each condition across all calibration points
The calibData dataframe has summarized each individual calibration pt (9 total) for each unique condition. Before any other analyses, average the calibration performance across these 9pts for each condition

```{r chunk2} 
# load dplyr library
library(dplyr)

# group by unique conditions, and take the mean of all numeric columns
dat <- calibData %>% 
  group_by(subj, glasses, dist, offset) %>%
  summarise_if(is.numeric, mean)

# drop the columns that are now irrelevant
dat <- dat %>% select(-one_of(c("trial", "ptIdx")))

# show a table
kable(dat[1:5,], caption='Calibration data, mean by unique condition')
```



# Model the data  

---

## Overall

Collapsing across all conditions, is glasses model a significant predictor of accuracy or precision? Fit a linear mixed-effects model with glasses (fixed effect) and subject (random effect).

#### Accuracy

```{r chunk3}
# load the lme4 packages, which includes functions for fitting mixed models
library(lme4)
library(lmerTest)

# build linear mixed effects model predicting accuracy (i.e. centDist) 
accMod.overall <- lmer(centDist ~ glasses + (1|subj), data=dat)
summary(accMod.overall)
anova(accMod.overall)
```

Glasses Model is a significant predictor of accuracy. Next, run pairwise comparisons on glasses models to look for overall differences between glasses models. (Methods for running pairwise t-tests on linear model object found at: https://stats.stackexchange.com/questions/237512/how-to-perform-post-hoc-test-on-lmer-model)

```{r chunk4}
library(multcomp)

summary(glht(accMod.overall, linfct = mcp(glasses = "Tukey")), test = adjusted("holm"))
```

Overall, there is a significant difference in accuracy between Pupil Labs and SMI, and Pupil Labs and Tobii. No significant different between SMI and Tobii. 

#### Precision
 Fit a similar linear mixed-effects model looking at precision instead of accuracy
 
 
```{r chunk5}
# build linear mixed effects model predicting precision (i.e. RMS) 
precMod.overall <- lmer(RMS ~ glasses + (1|subj), data=dat)
summary(precMod.overall)
anova(precMod.overall)
```

Glasses model is a significant predictor of overall precision. Next, run pairwise comparisons on glasses models to look for overall differences between glasses models.

```{r chunk6}
summary(glht(precMod.overall, linfct = mcp(glasses = "Tukey")), test = adjusted("holm"))
```
Tobii exhibits significantly different precision than either SMI or Pupil Labs. No significant difference between SMI and Pupil Labs.

#### Overall Accuracy and Precision Plots

Plot Accuracy and Precision by Glasses Model

```{r chunk7}
# overall Accuracy plot
library(ggplot2)
library(ggthemes)
library(ggpubr)

## Accuracy
accPlot <- ggplot(aes(y = centDist, x = glasses, fill=glasses), 
       data = dat) +
  geom_boxplot() +
  labs( 
    x = "Wearable Eye-tracker",
    y = "Visual Angle (deg)",
    title="Accuracy"
    ) +
  scale_fill_brewer(palette="Greens") +
  scale_y_continuous(breaks=seq(0,2,by=1), limits=c(0,2.5), expand=c(0,.1)) +
  theme(
    aspect.ratio = 1.5,
    panel.background = element_blank(),
    plot.title = element_text(hjust=.5, size=18),
    axis.title = element_text(size=rel(1.3)),
    axis.text.x = element_text(size = rel(1.3)),
    axis.text.y = element_text(size = rel(1.5)),
    axis.line.y = element_line(colour = "black", size = .5, linetype = "solid"),
    axis.ticks.x = element_blank(),
    panel.grid.major.y = element_line(colour="darkgrey", linetype = "twodash", size=.25),
    legend.position = "none",
  ) +
  geom_segment(aes(x = .4, y = 0, xend = 3.6, yend = 0), size=.25)


## Precision
rmsPlot <- ggplot(aes(y = RMS, x = glasses, fill=glasses), 
                  data = dat) +
  geom_boxplot() +
  labs( 
    x = "Wearable Eye-tracker",
    y = "RMS",
    title="Precision"
  ) +
  scale_fill_brewer(palette="Greens") +
  scale_y_continuous(breaks=seq(0,.8,by=.2), limits=c(0,.7), expand=c(0,.03)) +
  theme(
    aspect.ratio = 1.5,
    panel.background = element_blank(),
    plot.title = element_text(hjust=.5, size=18),
    axis.title = element_text(size=rel(1.3)),
    axis.text.x = element_text(size = rel(1.3)),
    axis.text.y = element_text(size = rel(1.5)),
    axis.line.y = element_line(colour = "black", size = .5, linetype = "solid"),
    axis.ticks.x = element_blank(),
    panel.grid.major.y = element_line(colour="darkgrey", linetype = "twodash", size=.25),
    legend.position = "none",
  ) +
  geom_segment(aes(x = .4, y = 0, xend = 3.6, yend = 0), size=.25)

## Combine plots
ggarrange(accPlot, rmsPlot,  
          labels = c("A", "B"),
          ncol = 2, nrow = 1) + 
  ggsave("figs/overallAccPrec.pdf", width = 8, height = 5)
```





Fit separate models to the accuracy and precision data (i.e. centDist and RMS, respectively). Set up each model to include the following main effects:

* **glasses**
* **distance**
* **offset**

and the following interactions:

* **glasses** X **distance**
* **glasses** X **offset**
* **glasses** X **distance** X **offset**




 



---
## Session Info  
Display all session info (R and R package version numbers)
```{r}
sessionInfo()
```


